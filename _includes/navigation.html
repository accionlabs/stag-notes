{% comment %}
  Simple, reliable navigation generator for _docs folder
{% endcomment %}

{% assign docs_pages = site.docs | where_exp: "item", "item.nav_exclude != true" %}

<ul class="nav-tree">
  {% assign root_folders = "" | split: "" %}
  
  {% comment %} Find all unique root-level folders {% endcomment %}
  {% for doc in docs_pages %}
    {% assign doc_path = doc.path | remove: "_docs/" %}
    {% assign path_parts = doc_path | split: "/" %}
    
    {% if path_parts.size > 1 %}
      {% assign folder_name = path_parts[0] %}
      {% unless root_folders contains folder_name %}
        {% assign root_folders = root_folders | push: folder_name %}
      {% endunless %}
    {% endif %}
  {% endfor %}
  
  {% comment %} Render each root folder {% endcomment %}
  {% for folder in root_folders %}
    {% comment %} Find files in this folder {% endcomment %}
    {% assign folder_files = "" | split: "" %}
    {% assign folder_description = "" %}
    
    {% for doc in docs_pages %}
      {% assign doc_path = doc.path | remove: "_docs/" %}
      {% assign path_parts = doc_path | split: "/" %}
      
      {% if path_parts[0] == folder %}
        {% if path_parts.size == 2 and path_parts[1] != "index" %}
          {% assign folder_files = folder_files | push: doc %}
        {% elsif path_parts[1] == "index" %}
          {% assign folder_description = doc.description %}
        {% endif %}
      {% endif %}
    {% endfor %}
    
    {% comment %} Sort files in this folder alphabetically by title (case-insensitive) {% endcomment %}
    {% assign sorted_folder_files = "" | split: "" %}
    {% assign file_titles = "" | split: "" %}
    
    {% comment %} Create array of titles for sorting {% endcomment %}
    {% for doc in folder_files %}
      {% assign display_title = doc.title | default: doc.name | remove: ".md" | downcase %}
      {% assign file_titles = file_titles | push: display_title %}
    {% endfor %}
    
    {% comment %} Sort titles alphabetically {% endcomment %}
    {% assign sorted_titles = file_titles | sort %}
    
    {% comment %} Rebuild files array in sorted order {% endcomment %}
    {% for sorted_title in sorted_titles %}
      {% for doc in folder_files %}
        {% assign doc_title = doc.title | default: doc.name | remove: ".md" | downcase %}
        {% if doc_title == sorted_title %}
          {% assign sorted_folder_files = sorted_folder_files | push: doc %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endfor %}
    
    {% comment %} Check if current page is in this folder {% endcomment %}
    {% assign is_current_folder = false %}
    {% assign current_doc_path = page.path | remove: "_docs/" %}
    {% assign current_path_parts = current_doc_path | split: "/" %}
    {% if current_path_parts[0] == folder %}
      {% assign is_current_folder = true %}
    {% endif %}
    
    <li class="nav-folder">
      <div class="nav-folder-header {% if is_current_folder %}active{% endif %}">
        <button class="folder-toggle" data-target="folder-{{ folder | slugify }}" aria-expanded="{% if is_current_folder %}true{% else %}false{% endif %}">
          <span class="folder-icon">üìÅ</span>
          <span class="folder-name">{{ folder }}</span>
          <span class="item-count">({{ sorted_folder_files | size }})</span>
          <span class="toggle-icon">‚ñ∂</span>
        </button>
      </div>
      {% if folder_description %}
        <div class="folder-description">{{ folder_description }}</div>
      {% endif %}
      
      <ul class="nav-subtree {% if is_current_folder %}expanded{% endif %}" id="folder-{{ folder | slugify }}">
        {% comment %} Render files in folder {% endcomment %}
        {% for doc in sorted_folder_files %}
          {% assign is_current = false %}
          {% if page.path == doc.path %}
            {% assign is_current = true %}
          {% endif %}
          
          <li class="nav-file">
            <a href="{{ doc.url | relative_url }}" class="nav-link {% if is_current %}current{% endif %}">
              <span class="file-icon">üìÑ</span>
              <span class="file-name">{{ doc.title | default: doc.name | remove: ".md" }}</span>
            </a>
          </li>
        {% endfor %}
      </ul>
    </li>
  {% endfor %}
</ul>